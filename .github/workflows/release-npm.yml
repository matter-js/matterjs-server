# This workflow reacts on a PR labeled with "automated-npm-release" will automatically merge it and
# create a new release on npm.
name: Automatic Labeled NPM Release

permissions:
  contents: write
  pull-requests: write
  packages: write  # Required for ghcr.io
  id-token: write  # Required for OIDC

on:
  pull_request:
    types: [labeled]

# Cancel previous PR/branch runs when a new commit is pushed
concurrency:
  group: ${{ github.ref }}-auto-npm-release
  cancel-in-progress: true

jobs:
  check-and-lint:
    if: github.repository == 'matter-js/matterjs-server' && contains(github.event.pull_request.labels.*.name, 'automated-npm-release')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Prepare testing environment
        uses: ./.github/actions/prepare-env
      - run: npm run format-verify
      - run: npm run lint

  build-non-linux:
    if: github.repository == 'matter-js/matterjs-server' && contains(github.event.pull_request.labels.*.name, 'automated-npm-release')
    needs: [ check-and-lint ]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        node-version: [ 20.x, 22.x, 24.x ]
        os: [ macos-latest, windows-latest ]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        # needed as long as we test Node.js 16 and npm <10.2.2 is used for Node.js 18/20
        with:
          python-version: '3.11'
      - name: Build on ${{ matrix.os }}
        uses: ./.github/actions/prepare-env
        with:
          node-version: ${{ matrix.node-version }}
          os: ${{ matrix.os }}

  test:
    if: github.repository == 'matter-js/matterjs-server' && contains(github.event.pull_request.labels.*.name, 'automated-npm-release')
    needs: [ check-and-lint ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [ 20.x, 22.x, 24.x ]
    steps:
      - uses: actions/checkout@v6
      - name: Prepare testing environment
        uses: ./.github/actions/prepare-env
        with:
          node-version: ${{ matrix.node-version }}
      - name: Execute tests
        run: npm run test

  auto-merge:
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      github.repository == 'matter-js/matterjs-server' &&
      contains(github.event.pull_request.labels.*.name, 'automated-npm-release')
    needs: [ test, build-non-linux, check-and-lint ]
    runs-on: ubuntu-latest
    steps:
      - id: automerge
        name: automerge
        uses: "pascalgn/automerge-action@v0.16.4"
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: "automated-npm-release"
          MERGE_FILTER_AUTHOR: "Automator77"
          MERGE_FORKS: "false"
          MERGE_DELETE_BRANCH: "false"
          UPDATE_LABELS: "automated-npm-release"
          MERGE_METHOD: "squash"
          MERGE_RETRIES: "50"
          MERGE_RETRY_SLEEP: "60000"

      - name: Checkout repository
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: actions/checkout@v6

      - name: Use Node.js 22.x
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: actions/setup-node@v6
        with:
          node-version: 22.x

      - name: Install dependencies and build
        if: steps.automerge.outputs.mergeResult == 'merged'
        run: npm ci

      - name: Determine version
        if: steps.automerge.outputs.mergeResult == 'merged'
        id: version
        uses: actions/github-script@v8
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            return fs.readFileSync(`${process.env.GITHUB_WORKSPACE}/version.txt`, "utf8");

      - name: Apply new version to package files
        if: steps.automerge.outputs.mergeResult == 'merged'
        run: npm run version -- --apply

      - name: Publish npm
        if: steps.automerge.outputs.mergeResult == 'merged'
        env:
          PRERELEASE: ${{ contains(steps.version.outputs.result, '-') }}
        run: |
          npm install -g npm@latest

          if [[ "$PRERELEASE" == "true" ]]; then
            npm publish --workspaces --tag dev
          else
            npm publish --workspaces
          fi

      - name: Wait for npm registry
        if: steps.automerge.outputs.mergeResult == 'merged'
        run: sleep 120

      - name: Set up Python for PyPI publish
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Python build tools
        if: steps.automerge.outputs.mergeResult == 'merged'
        run: pip install build tomli tomli-w

      - name: Convert version to PEP 440 and set in pyproject.toml
        if: steps.automerge.outputs.mergeResult == 'merged'
        id: python_version
        shell: python
        env:
          SEMVER_VERSION: ${{ steps.version.outputs.result }}
        run: |
          import re, os, tomli, tomli_w

          version = os.environ["SEMVER_VERSION"]

          # Convert semver to PEP 440
          match = re.match(r'^(\d+\.\d+\.\d+)(?:-(.+))?$', version)
          if not match:
              raise SystemExit(
                  f"Invalid SEMVER_VERSION format: {version!r}. "
                  "Expected 'MAJOR.MINOR.PATCH' or 'MAJOR.MINOR.PATCH-prerelease'."
              )
          base = match.group(1)
          prerelease = match.group(2)

          if prerelease:
              parts = prerelease.split('-')
              pre_type_num = parts[0]
              date_str = parts[1] if len(parts) > 1 else "0"
              pre_type, pre_num = pre_type_num.split('.') if '.' in pre_type_num else (pre_type_num, "0")
              pep440_pre = {'alpha': 'a', 'beta': 'b', 'rc': 'rc'}.get(pre_type, 'a')
              pep440_version = f"{base}{pep440_pre}{pre_num}.dev{date_str}"
          else:
              pep440_version = base

          print(f"Semver: {version} -> PEP 440: {pep440_version}")

          with open("python_client/pyproject.toml", "rb") as f:
              pyproject = tomli.load(f)
          pyproject["project"]["version"] = pep440_version
          with open("python_client/pyproject.toml", "wb") as f:
              tomli_w.dump(pyproject, f)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"pep440_version={pep440_version}\n")

      - name: Build Python client package
        if: steps.automerge.outputs.mergeResult == 'merged'
        run: python3 -m build python_client/

      - name: Publish Python client to PyPI
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: pypa/gh-action-pypi-publish@v1.8.14
        with:
          packages-dir: python_client/dist/

      - name: Log in to GitHub Container Registry
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: docker/setup-buildx-action@v3.12.0

      - name: Version number for Docker tags
        if: steps.automerge.outputs.mergeResult == 'merged'
        id: docker_tags
        shell: bash
        run: |
          version="${{ steps.version.outputs.result }}"
          echo "patch=${version}" >> $GITHUB_OUTPUT
          echo "minor=${version%.*}" >> $GITHUB_OUTPUT
          echo "major=${version%.*.*}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image (release)
        if: steps.automerge.outputs.mergeResult == 'merged' && !contains(steps.version.outputs.result, '-')
        uses: docker/build-push-action@v6.19.2
        with:
          context: ./docker/matterjs-server
          platforms: linux/amd64,linux/arm64
          file: ./docker/matterjs-server/Dockerfile
          tags: |
            ghcr.io/${{ github.repository_owner }}/matterjs-server:${{ steps.docker_tags.outputs.patch }}
            ghcr.io/${{ github.repository_owner }}/matterjs-server:${{ steps.docker_tags.outputs.minor }}
            ghcr.io/${{ github.repository_owner }}/matterjs-server:${{ steps.docker_tags.outputs.major }}
            ghcr.io/${{ github.repository_owner }}/matterjs-server:stable
            ghcr.io/${{ github.repository_owner }}/matterjs-server:latest
            ghcr.io/${{ github.repository_owner }}/matterjs-server:dev
          push: true
          build-args: |
            MATTERJS_SERVER_VERSION=${{ steps.version.outputs.result }}

      - name: Build and push Docker image (pre-release)
        if: steps.automerge.outputs.mergeResult == 'merged' && contains(steps.version.outputs.result, '-')
        uses: docker/build-push-action@v6.19.2
        with:
          context: ./docker/matterjs-server
          platforms: linux/amd64,linux/arm64
          file: ./docker/matterjs-server/Dockerfile
          tags: |
            ghcr.io/${{ github.repository_owner }}/matterjs-server:${{ steps.docker_tags.outputs.patch }}
            ghcr.io/${{ github.repository_owner }}/matterjs-server:dev
          push: true
          build-args: |
            MATTERJS_SERVER_VERSION=${{ steps.version.outputs.result }}

      - name: Create Github Release
        if: steps.automerge.outputs.mergeResult == 'merged'
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: v${{ steps.version.outputs.result }}
          name: Release v${{ steps.version.outputs.result }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.result, '-') }}
          body: ${{ contains(steps.version.outputs.result, '-') && 'Nightly release' || format('Official release, check [CHANGELOG.md]({0}) for details', 'https://github.com/matter-js/matterjs-server/blob/main/CHANGELOG.md') }}
