name: Release Python Client

on:
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.12"

jobs:
  release-python-client:
    name: Build and publish Python client to PyPI
    if: startsWith(github.event.release.tag_name, 'python-client-')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/python-client-}" >> $GITHUB_OUTPUT

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: pip install build tomli tomli-w

      - name: Set version in pyproject.toml
        shell: python
        run: |
          import tomli, tomli_w
          with open("python_client/pyproject.toml", "rb") as f:
              pyproject = tomli.load(f)
          pyproject["project"]["version"] = "${{ steps.version.outputs.version }}"
          with open("python_client/pyproject.toml", "wb") as f:
              tomli_w.dump(pyproject, f)

      - name: Build package
        run: python3 -m build python_client/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.8.14
        with:
          user: __token__
          password: ${{ secrets.PYPI_TOKEN }}
          packages-dir: python_client/dist/
