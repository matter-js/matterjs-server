FROM node:22-trixie-slim

# Set shell
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install required system dependencies
# - iputils-ping: Required for node ping functionality
# - curl: For health checks and general utility
# - git: Required for npm install from git repos
RUN \
    set -x \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        iputils-ping \
        curl \
        git \
    && apt-get purge -y --auto-remove \
    && rm -rf \
        /var/lib/apt/lists/* \
        /usr/src/*

WORKDIR /app

# Copy package files first for better caching
COPY package*.json ./
COPY packages/tools/package*.json ./packages/tools/
COPY packages/custom-clusters/package*.json ./packages/custom-clusters/
COPY packages/ws-controller/package*.json ./packages/ws-controller/
COPY packages/ws-client/package*.json ./packages/ws-client/
COPY packages/dashboard/package*.json ./packages/dashboard/
COPY packages/matter-server/package*.json ./packages/matter-server/

# Install dependencies
RUN npm ci

# Copy source code
COPY . .

# Build all packages
RUN npm run build

# Data volume for persistent storage
VOLUME ["/data"]

# WebSocket API port
EXPOSE 5580

# Health check - verify the server is responding
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:5580/ || exit 1

# Run the matter server with data stored in /data
# --enable-source-maps provides better stack traces in error logs
ENTRYPOINT ["node", "--enable-source-maps", "packages/matter-server/dist/esm/MatterServer.js"]
CMD ["--storage-path", "/data"]
